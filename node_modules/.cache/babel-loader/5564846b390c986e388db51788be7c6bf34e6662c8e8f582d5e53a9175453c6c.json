{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\josep\\\\Documents\\\\Sistema de Encuestas por Voz\\\\client\\\\src\\\\pages\\\\TakeSurvey.jsx\",\n  _s = $RefreshSig$();\nimport React, { useState, useEffect, useRef } from 'react';\nimport { useParams, useNavigate } from 'react-router-dom';\nimport { SurveyService, ResponseService } from '../services/apiService';\n\n// Componentes\nimport LoadingSpinner from '../components/LoadingSpinner';\nimport ErrorMessage from '../components/ErrorMessage';\nimport audioService from '../services/audioService';\n// Importar servicio de procesamiento de lenguaje natural\nimport * as nlpService from '../services/nlpService';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst TakeSurvey = () => {\n  _s();\n  const {\n    surveyId\n  } = useParams();\n  const navigate = useNavigate();\n\n  // Referencias para controlar el flujo de la conversación\n  const conversationActive = useRef(false);\n  const speakTimeoutRef = useRef(null);\n\n  // Estados\n  const [survey, setSurvey] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);\n  const [responses, setResponses] = useState([]);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [showConfirmation, setShowConfirmation] = useState(false);\n  const [currentResponse, setCurrentResponse] = useState('');\n  const [isListening, setIsListening] = useState(false);\n  const [voiceEnabled, setVoiceEnabled] = useState(true);\n  const [conversationState, setConversationState] = useState('idle'); // idle, speaking, listening, processing\n  const [conversationMessage, setConversationMessage] = useState('');\n  const [micPermission, setMicPermission] = useState('unknown'); // 'unknown', 'granted', 'denied'\n  const [recognizedText, setRecognizedText] = useState('');\n  const [status, setStatus] = useState('');\n  const [showPermissionDialog, setShowPermissionDialog] = useState(false);\n\n  // Verificar permiso del micrófono\n  const requestMicrophonePermission = async () => {\n    setConversationState('requesting_permission');\n    setConversationMessage('Solicitando permiso para el micrófono...');\n    try {\n      const permissionGranted = await audioService.requestMicrophonePermission();\n      if (permissionGranted) {\n        setMicPermission('granted');\n        setShowPermissionDialog(false);\n        setConversationMessage('Permiso concedido. Iniciando encuesta por voz...');\n\n        // Pequeño retraso para iniciar la conversación\n        setTimeout(() => {\n          startConversation();\n        }, 1000);\n      } else {\n        setMicPermission('denied');\n        setConversationState('permission_denied');\n        setConversationMessage('Se necesita acceso al micrófono para usar la función de voz');\n      }\n    } catch (error) {\n      console.error('Error al solicitar permiso:', error);\n      setMicPermission('denied');\n      setConversationState('error');\n      setConversationMessage('Error al solicitar permiso del micrófono');\n    }\n  };\n\n  // Cargar la encuesta\n  useEffect(() => {\n    const fetchSurvey = async () => {\n      try {\n        const data = await SurveyService.getPublicSurvey(surveyId);\n        console.log('Encuesta cargada:', data);\n        setSurvey(data);\n        // Inicializar respuestas vacías\n        setResponses(new Array(data.questions.length).fill(''));\n      } catch (error) {\n        console.error('Error al cargar la encuesta:', error);\n        setError('No se pudo cargar la encuesta. Verifique que el ID sea correcto y que la encuesta esté activa.');\n      } finally {\n        setLoading(false);\n      }\n    };\n    fetchSurvey();\n\n    // Inicializar sistema de voz\n    audioService.initSpeechSystem();\n\n    // Configurar el callback para cambios en el permiso del micrófono\n    audioService.onPermissionChange((granted, errorMsg) => {\n      setMicPermission(granted ? 'granted' : 'denied');\n      if (!granted && errorMsg) {\n        setConversationMessage(`Error de permiso: ${errorMsg}`);\n        setConversationState('permission_denied');\n      }\n    });\n    return () => {\n      // Detener cualquier síntesis y reconocimiento al desmontar\n      if (speakTimeoutRef.current) {\n        clearTimeout(speakTimeoutRef.current);\n      }\n      audioService.stop();\n      conversationActive.current = false;\n      if (window.speechSynthesis) {\n        window.speechSynthesis.cancel();\n      }\n    };\n  }, [surveyId]);\n\n  // Iniciar la conversación una vez que la encuesta esté cargada\n  useEffect(() => {\n    if (survey && voiceEnabled && !conversationActive.current) {\n      // Primero verificar permiso de micrófono\n      if (micPermission === 'granted') {\n        startConversation();\n      } else if (micPermission === 'unknown') {\n        // Mostrar diálogo de permiso\n        setShowPermissionDialog(true);\n      }\n    }\n  }, [survey, voiceEnabled, micPermission]);\n\n  // Función para iniciar la conversación\n  const startConversation = () => {\n    if (!voiceEnabled || !survey) return;\n    conversationActive.current = true;\n\n    // Dar un mensaje de bienvenida\n    if (survey.welcomeMessage) {\n      speakText(survey.welcomeMessage, () => {\n        // Después de la bienvenida, preguntar la primera pregunta\n        speakCurrentQuestion();\n      });\n    } else {\n      // Si no hay mensaje de bienvenida, ir directamente a la primera pregunta\n      speakCurrentQuestion();\n    }\n  };\n\n  // Función para hablar el texto usando el servicio de audio con pausas naturales\n  const speakText = (text, onEndCallback) => {\n    if (!voiceEnabled) {\n      if (onEndCallback) onEndCallback();\n      return;\n    }\n    console.log('Preparando para hablar:', text);\n\n    // Cancela cualquier síntesis en curso y limpia los timeouts anteriores\n    if (window.speechSynthesis) {\n      window.speechSynthesis.cancel();\n    }\n    if (speakTimeoutRef.current) {\n      clearTimeout(speakTimeoutRef.current);\n      speakTimeoutRef.current = null;\n    }\n\n    // Detener cualquier reconocimiento en curso para evitar conflictos\n    audioService.stop();\n\n    // Pausa significativa antes de comenzar a hablar (1 segundo)\n    speakTimeoutRef.current = setTimeout(() => {\n      setConversationState('speaking');\n      setConversationMessage('Hablando: ' + text.substring(0, 30) + (text.length > 30 ? '...' : ''));\n\n      // Calcular un tiempo estimado basado en la longitud del texto (125ms por carácter para ser más conservador)\n      const estimatedSpeakTime = Math.max(4000, text.length * 125);\n      console.log(`Tiempo estimado para hablar: ${estimatedSpeakTime}ms`);\n      audioService.speakText(text, () => {\n        console.log('Comenzando a hablar:', text);\n      }, () => {\n        console.log('Terminó de hablar la frase completa');\n        setConversationState('processing');\n        setConversationMessage('Procesando...');\n\n        // Esperar un tiempo más largo después de hablar (2 segundos) para una pausa natural\n        // Esta pausa simula el tiempo que una persona tomaría para procesar lo que escuchó\n        speakTimeoutRef.current = setTimeout(() => {\n          setConversationState('idle');\n          if (onEndCallback) {\n            onEndCallback();\n          }\n        }, 2000);\n      }, error => {\n        console.error('Error al hablar:', error);\n        setConversationState('error');\n        setConversationMessage(`Error: ${error}`);\n\n        // En caso de error, esperar un poco antes de continuar\n        speakTimeoutRef.current = setTimeout(() => {\n          setConversationState('idle');\n          if (onEndCallback) {\n            onEndCallback();\n          }\n        }, 1500);\n      });\n    }, 1000); // Esperar 1 segundo antes de iniciar una nueva síntesis para asegurar separación clara\n  };\n\n  // Función para hablar la pregunta actual\n  const speakCurrentQuestion = () => {\n    if (!survey || !voiceEnabled) return;\n    const currentQuestion = survey.questions[currentQuestionIndex];\n    if (!currentQuestion) return;\n    let questionText = `Pregunta ${currentQuestionIndex + 1}: ${currentQuestion.text}`;\n\n    // Agregar información sobre opciones si es pregunta de opción múltiple\n    if (currentQuestion.type === 'multiple_choice' && currentQuestion.options) {\n      questionText += '. Las opciones son: ';\n      questionText += currentQuestion.options.map((option, idx) => `Opción ${idx + 1}: ${option}`).join(', ');\n    }\n    speakText(questionText, () => {\n      // Después de hablar la pregunta, iniciar el reconocimiento de voz\n      startListening();\n    });\n  };\n\n  // Función para iniciar la escucha de la respuesta del usuario\n  const startListening = async () => {\n    if (!voiceEnabled) return;\n    if (!audioService.isSupportedByBrowser()) {\n      setError('Tu navegador no soporta reconocimiento de voz');\n      return;\n    }\n    if (micPermission !== 'granted') {\n      await requestMicrophonePermission();\n      return;\n    }\n    audioService.init('es-ES');\n    setRecognizedText('');\n    audioService.onResult((transcript, isFinal) => {\n      setCurrentResponse(transcript);\n      setStatus(isFinal ? 'Procesando...' : 'Escuchando...');\n    });\n    audioService.onEnd(finalTranscript => {\n      setIsListening(false);\n      setConversationState('processing');\n      setConversationMessage('Procesando respuesta...');\n\n      // Guardar la respuesta y continuar la conversación\n      handleVoiceResponse(finalTranscript);\n    });\n    audioService.onError(errorMessage => {\n      console.error('Error de reconocimiento:', errorMessage);\n      setError(`Error de reconocimiento: ${errorMessage}`);\n      setIsListening(false);\n      setConversationState('idle');\n\n      // Reintentar la escucha después de un error\n      speakTimeoutRef.current = setTimeout(() => {\n        speakText('No pude entender tu respuesta. Por favor, inténtalo de nuevo.', () => {\n          startListening();\n        });\n      }, 1000);\n    });\n    try {\n      const started = await audioService.start();\n      if (started) {\n        setIsListening(true);\n        setConversationState('listening');\n        setConversationMessage('Escuchando...');\n      } else {\n        setError('No se pudo iniciar el reconocimiento de voz');\n        setConversationState('idle');\n      }\n    } catch (error) {\n      setError(`Error al iniciar reconocimiento: ${error.message || 'Error desconocido'}`);\n      setConversationState('idle');\n    }\n  };\n\n  // Manejar la respuesta por voz\n  const handleVoiceResponse = response => {\n    if (!response || response.trim() === '') {\n      // Si no hay respuesta, pedir que repita\n      speakText('No he escuchado ninguna respuesta. Por favor, intenta de nuevo.', () => {\n        startListening();\n      });\n      return;\n    }\n\n    // Guardar la respuesta actual\n    const updatedResponses = [...responses];\n    updatedResponses[currentQuestionIndex] = response;\n    setResponses(updatedResponses);\n\n    // Dar feedback al usuario\n    speakText(`He registrado tu respuesta: ${response}.`, () => {\n      // Pasar a la siguiente pregunta o finalizar\n      if (currentQuestionIndex < survey.questions.length - 1) {\n        setCurrentQuestionIndex(currentQuestionIndex + 1);\n        setCurrentResponse('');\n        // Hablar la siguiente pregunta después de un breve pausa\n        speakTimeoutRef.current = setTimeout(() => {\n          speakCurrentQuestion();\n        }, 1000);\n      } else {\n        // Si es la última pregunta, mostrar confirmación\n        setShowConfirmation(true);\n        speakText('Hemos terminado todas las preguntas. Ahora te mostraré un resumen de tus respuestas para que las confirmes.', () => {\n          speakConfirmationSummary();\n        });\n      }\n    });\n  };\n\n  // Leer el resumen de confirmación\n  const speakConfirmationSummary = () => {\n    if (!voiceEnabled || !showConfirmation) return;\n    let summaryText = 'Resumen de tus respuestas: ';\n    survey.questions.forEach((question, index) => {\n      summaryText += `Pregunta ${index + 1}: ${question.text}. Tu respuesta: ${responses[index] || \"Sin respuesta\"}. `;\n    });\n    summaryText += '¿Deseas enviar estas respuestas o volver para revisar alguna?';\n    speakText(summaryText, () => {\n      // Escuchar confirmación del usuario\n      listenForConfirmation();\n    });\n  };\n\n  // Escuchar la confirmación del usuario usando NLP para mejor reconocimiento\n  const listenForConfirmation = () => {\n    if (!voiceEnabled) return;\n\n    // Esperar un momento antes de empezar a escuchar para dar tiempo a que termine de hablar\n    // y para simular un ritmo de conversación natural\n    setConversationState('waiting');\n    setConversationMessage('Esperando tu respuesta...');\n\n    // Esperar 3 segundos antes de empezar a escuchar para una interacción más natural\n    setTimeout(() => {\n      audioService.init('es-ES');\n      audioService.onResult((transcript, isFinal) => {\n        // Mostrar lo que está diciendo el usuario en tiempo real\n        setCurrentResponse(transcript);\n        setConversationMessage(isFinal ? 'Procesando tu respuesta...' : `Escuchando: ${transcript}`);\n      });\n      audioService.onEnd(finalTranscript => {\n        setIsListening(false);\n        setConversationState('processing');\n        setConversationMessage('Analizando respuesta...');\n        console.log('Respuesta final recibida:', finalTranscript);\n\n        // Usar una pausa para procesar la respuesta y dar una sensación más natural\n        setTimeout(() => {\n          // Analizar respuesta utilizando NLP para una mejor comprensión\n          try {\n            // Utilizar el servicio NLP para analizar respuesta de forma más precisa\n            const result = nlpService.analyzeIntent(finalTranscript.toLowerCase());\n            console.log('Análisis NLP:', result);\n\n            // Comprobar si la intención es afirmativa\n            const isAffirmative = result.intent === 'afirmacion' || finalTranscript.toLowerCase().includes('sí') || finalTranscript.toLowerCase().includes('si') || finalTranscript.toLowerCase().includes('confirmar') || finalTranscript.toLowerCase().includes('enviar');\n\n            // Comprobar si la intención es negativa\n            const isNegative = result.intent === 'negacion' || finalTranscript.toLowerCase().includes('no') || finalTranscript.toLowerCase().includes('revisar') || finalTranscript.toLowerCase().includes('volver');\n            if (isAffirmative) {\n              // Confirmado - enviar respuestas\n              setConversationState('confirmed');\n              setConversationMessage('Confirmado. Enviando respuestas...');\n              speakText('Perfecto, estoy enviando tus respuestas ahora.', () => {\n                handleSubmit();\n              });\n            } else if (isNegative) {\n              // Volver a revisar\n              setConversationState('reviewing');\n              setConversationMessage('Volviendo a revisar las preguntas...');\n              setShowConfirmation(false);\n              speakText('De acuerdo, volvamos a revisar las preguntas. Puedes navegar entre ellas usando los botones de anterior y siguiente.', null);\n            } else {\n              // Respuesta no clara - pedir clarificación\n              setConversationState('unclear');\n              setConversationMessage('No entendí tu respuesta...');\n              speakText('No he entendido si deseas confirmar o revisar. Por favor, dime claramente \"confirmar\" para enviar las respuestas o \"revisar\" para volver a las preguntas.', () => {\n                // Intentar nuevamente después de una pausa \n                setTimeout(() => {\n                  listenForConfirmation();\n                }, 2000); // Esperar 2 segundos antes de volver a escuchar\n              });\n            }\n          } catch (error) {\n            console.error('Error al procesar la respuesta con NLP:', error);\n            // Fallback al método simple en caso de error con NLP\n            const lowerResponse = finalTranscript.toLowerCase();\n            if (lowerResponse.includes('sí') || lowerResponse.includes('si') || lowerResponse.includes('confirmar') || lowerResponse.includes('enviar')) {\n              speakText('Perfecto, enviando tus respuestas.', () => {\n                handleSubmit();\n              });\n            } else if (lowerResponse.includes('no') || lowerResponse.includes('revisar')) {\n              setShowConfirmation(false);\n              speakText('De acuerdo, volvamos a revisar las preguntas.', null);\n            } else {\n              speakText('No he entendido tu respuesta. Por favor, intenta de nuevo.', () => {\n                setTimeout(() => {\n                  listenForConfirmation();\n                }, 2000);\n              });\n            }\n          }\n        }, 1500); // Pausa para procesar la respuesta\n      });\n      audioService.onError(errorMessage => {\n        console.error('Error en reconocimiento de voz:', errorMessage);\n        setIsListening(false);\n        setConversationState('error');\n        setConversationMessage(`Error al escuchar: ${errorMessage}`);\n        speakText('Hubo un problema al escuchar tu confirmación. Por favor, usa los botones en pantalla para confirmar o volver, o intenta hablar más claramente.', null);\n      });\n\n      // Iniciar el reconocimiento de voz\n      audioService.start();\n      setIsListening(true);\n      setConversationState('listening');\n      setConversationMessage('Escuchando tu confirmación...');\n\n      // Reproducir un sonido suave para indicar que está listo para escuchar\n      try {\n        const beep = new Audio('/assets/sounds/listen-beep.mp3');\n        beep.volume = 0.3;\n        beep.play();\n      } catch (error) {\n        console.log('No se pudo reproducir el sonido de inicio de escucha');\n      }\n    }, 3000); // Pausa considerable antes de empezar a escuchar\n  };\n\n  // Enviar todas las respuestas\n  const handleSubmit = async () => {\n    setIsSubmitting(true);\n    try {\n      // Preparar objeto de respuesta\n      const responseData = {\n        surveyId: survey._id,\n        responses: survey.questions.map((question, index) => ({\n          questionId: question._id,\n          questionText: question.text,\n          responseText: responses[index] || '',\n          questionType: question.type\n        }))\n      };\n\n      // Enviar respuesta a la API\n      await ResponseService.submitResponse(responseData);\n\n      // Mensaje de despedida\n      if (voiceEnabled) {\n        speakText(survey.farewell || '¡Gracias por completar la encuesta!', () => {\n          // Redirigir a página de agradecimiento\n          navigate(`/thank-you`, {\n            state: {\n              message: survey.farewell || '¡Gracias por completar la encuesta!'\n            }\n          });\n        });\n      } else {\n        // Redirigir a página de agradecimiento sin hablar\n        navigate(`/thank-you`, {\n          state: {\n            message: survey.farewell || '¡Gracias por completar la encuesta!'\n          }\n        });\n      }\n    } catch (error) {\n      console.error('Error al enviar respuestas:', error);\n      setError('Ocurrió un error al enviar tus respuestas. Por favor, intenta nuevamente.');\n      setIsSubmitting(false);\n      if (voiceEnabled) {\n        speakText('Ha ocurrido un error al enviar tus respuestas. Por favor, intenta nuevamente.', null);\n      }\n    }\n  };\n\n  // Renderizar pantalla de carga\n  if (loading) {\n    return /*#__PURE__*/_jsxDEV(LoadingSpinner, {}, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 523,\n      columnNumber: 12\n    }, this);\n  }\n\n  // Renderizar mensaje de error\n  if (error) {\n    return /*#__PURE__*/_jsxDEV(ErrorMessage, {\n      message: error\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 528,\n      columnNumber: 12\n    }, this);\n  }\n\n  // Si no hay encuesta\n  if (!survey) {\n    return /*#__PURE__*/_jsxDEV(ErrorMessage, {\n      message: \"No se encontr\\xF3 la encuesta solicitada.\"\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 533,\n      columnNumber: 12\n    }, this);\n  }\n\n  // Obtener la pregunta actual\n  const currentQuestion = survey.questions[currentQuestionIndex];\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"max-w-3xl mx-auto p-4\",\n    children: [/*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"mb-4 p-3 rounded-lg shadow-sm text-center bg-gray-100\",\n      children: [/*#__PURE__*/_jsxDEV(\"h2\", {\n        className: \"text-lg font-bold mb-2\",\n        children: survey.title\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 543,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n        className: \"text-sm mb-3\",\n        children: survey.description\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 544,\n        columnNumber: 9\n      }, this), micPermission === 'unknown' && /*#__PURE__*/_jsxDEV(\"button\", {\n        onClick: requestMicrophonePermission,\n        className: \"px-4 py-2 bg-blue-600 text-white rounded-md mb-2\",\n        children: \"Permitir micr\\xF3fono para continuar\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 547,\n        columnNumber: 11\n      }, this), micPermission === 'denied' && /*#__PURE__*/_jsxDEV(\"p\", {\n        className: \"text-red-600 mb-2\",\n        children: \"Se necesita acceso al micr\\xF3fono para usar la funci\\xF3n de voz.\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 556,\n        columnNumber: 11\n      }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n        className: \"font-semibold\",\n        children: showConfirmation ? \"Confirmación de respuestas\" : `Pregunta ${currentQuestionIndex + 1} de ${survey.questions.length}`\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 559,\n        columnNumber: 9\n      }, this), conversationState !== 'idle' && /*#__PURE__*/_jsxDEV(\"p\", {\n        className: \"mt-2 text-blue-700\",\n        children: conversationMessage\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 566,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 542,\n      columnNumber: 7\n    }, this), showConfirmation ? /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"bg-white rounded-lg shadow p-4 mb-4\",\n      children: [/*#__PURE__*/_jsxDEV(\"h3\", {\n        className: \"text-xl font-bold mb-3\",\n        children: \"Resumen de respuestas\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 573,\n        columnNumber: 11\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"max-h-60 overflow-y-auto mb-3\",\n        children: survey.questions.map((question, index) => /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"mb-2 pb-2 border-b border-gray-200\",\n          children: [/*#__PURE__*/_jsxDEV(\"p\", {\n            className: \"font-medium\",\n            children: [\"Pregunta \", index + 1, \": \", question.text]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 577,\n            columnNumber: 17\n          }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n            className: \"pl-4\",\n            children: responses[index] || \"(Sin respuesta)\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 578,\n            columnNumber: 17\n          }, this)]\n        }, question._id, true, {\n          fileName: _jsxFileName,\n          lineNumber: 576,\n          columnNumber: 15\n        }, this))\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 574,\n        columnNumber: 11\n      }, this), isListening ? /*#__PURE__*/_jsxDEV(\"p\", {\n        className: \"text-center text-green-700 animate-pulse\",\n        children: \"Di \\\"confirmar\\\" para enviar o \\\"revisar\\\" para volver\"\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 583,\n        columnNumber: 13\n      }, this) : /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex justify-end mt-2\",\n        children: [/*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: () => {\n            setShowConfirmation(false);\n            setConversationState('reviewing');\n            setConversationMessage('Revisando preguntas...');\n          },\n          className: \"px-3 py-1 bg-gray-200 text-gray-800 rounded mr-2\",\n          disabled: isSubmitting,\n          children: \"Revisar\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 588,\n          columnNumber: 15\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: handleSubmit,\n          className: \"px-3 py-1 bg-green-600 text-white rounded\",\n          disabled: isSubmitting,\n          children: isSubmitting ? 'Enviando...' : 'Confirmar'\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 599,\n          columnNumber: 15\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 587,\n        columnNumber: 13\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 572,\n      columnNumber: 9\n    }, this) : /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"bg-white rounded-lg shadow p-4 mb-4\",\n      children: [/*#__PURE__*/_jsxDEV(\"h3\", {\n        className: \"text-xl font-bold mb-3\",\n        children: currentQuestion.text\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 611,\n        columnNumber: 11\n      }, this), currentQuestion.type === 'multiple_choice' && currentQuestion.options && /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"mb-4\",\n        children: [/*#__PURE__*/_jsxDEV(\"p\", {\n          className: \"text-sm text-gray-600 mb-1\",\n          children: \"Opciones:\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 616,\n          columnNumber: 15\n        }, this), /*#__PURE__*/_jsxDEV(\"ul\", {\n          className: \"list-disc pl-5\",\n          children: currentQuestion.options.map((option, idx) => /*#__PURE__*/_jsxDEV(\"li\", {\n            className: \"mb-1\",\n            children: option\n          }, idx, false, {\n            fileName: _jsxFileName,\n            lineNumber: 619,\n            columnNumber: 19\n          }, this))\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 617,\n          columnNumber: 15\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 615,\n        columnNumber: 13\n      }, this), isListening ? /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"mt-3 p-3 bg-green-50 border border-green-200 rounded-md text-center animate-pulse\",\n        children: /*#__PURE__*/_jsxDEV(\"p\", {\n          children: [/*#__PURE__*/_jsxDEV(\"span\", {\n            className: \"font-medium\",\n            children: \"Escuchando\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 628,\n            columnNumber: 18\n          }, this), \": \", currentResponse || \"...\"]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 628,\n          columnNumber: 15\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 627,\n        columnNumber: 13\n      }, this) : /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"mt-3\",\n        children: [/*#__PURE__*/_jsxDEV(\"p\", {\n          className: \"text-sm font-medium text-gray-700\",\n          children: \"Tu respuesta:\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 632,\n          columnNumber: 15\n        }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n          className: \"p-2 bg-gray-50 rounded min-h-10\",\n          children: currentResponse || \"Esperando respuesta por voz...\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 633,\n          columnNumber: 15\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: startListening,\n          className: \"mt-2 px-3 py-1 bg-blue-500 text-white rounded-md text-sm\",\n          children: \"Responder por voz\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 634,\n          columnNumber: 15\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 631,\n        columnNumber: 13\n      }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n        className: \"flex justify-between mt-4\",\n        children: [/*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: () => {\n            if (currentQuestionIndex > 0) {\n              setCurrentQuestionIndex(currentQuestionIndex - 1);\n              setCurrentResponse(responses[currentQuestionIndex - 1]);\n            }\n          },\n          disabled: currentQuestionIndex === 0,\n          className: \"px-3 py-1 text-sm rounded disabled:opacity-50\",\n          children: \"\\u2190 Anterior\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 645,\n          columnNumber: 13\n        }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n          onClick: () => {\n            const updatedResponses = [...responses];\n            updatedResponses[currentQuestionIndex] = currentResponse;\n            setResponses(updatedResponses);\n            if (currentQuestionIndex < survey.questions.length - 1) {\n              setCurrentQuestionIndex(currentQuestionIndex + 1);\n              setCurrentResponse('');\n            } else {\n              setShowConfirmation(true);\n            }\n          },\n          className: \"px-3 py-1 text-sm bg-blue-500 text-white rounded\",\n          children: currentQuestionIndex < survey.questions.length - 1 ? 'Siguiente →' : 'Revisar respuestas'\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 657,\n          columnNumber: 13\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 644,\n        columnNumber: 11\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 610,\n      columnNumber: 9\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 540,\n    columnNumber: 5\n  }, this);\n};\n_s(TakeSurvey, \"/Q0DyABdRa+LNpr9Mnmxkw4ETzI=\", false, function () {\n  return [useParams, useNavigate];\n});\n_c = TakeSurvey;\nexport default TakeSurvey;\nvar _c;\n$RefreshReg$(_c, \"TakeSurvey\");","map":{"version":3,"names":["React","useState","useEffect","useRef","useParams","useNavigate","SurveyService","ResponseService","LoadingSpinner","ErrorMessage","audioService","nlpService","jsxDEV","_jsxDEV","TakeSurvey","_s","surveyId","navigate","conversationActive","speakTimeoutRef","survey","setSurvey","loading","setLoading","error","setError","currentQuestionIndex","setCurrentQuestionIndex","responses","setResponses","isSubmitting","setIsSubmitting","showConfirmation","setShowConfirmation","currentResponse","setCurrentResponse","isListening","setIsListening","voiceEnabled","setVoiceEnabled","conversationState","setConversationState","conversationMessage","setConversationMessage","micPermission","setMicPermission","recognizedText","setRecognizedText","status","setStatus","showPermissionDialog","setShowPermissionDialog","requestMicrophonePermission","permissionGranted","setTimeout","startConversation","console","fetchSurvey","data","getPublicSurvey","log","Array","questions","length","fill","initSpeechSystem","onPermissionChange","granted","errorMsg","current","clearTimeout","stop","window","speechSynthesis","cancel","welcomeMessage","speakText","speakCurrentQuestion","text","onEndCallback","substring","estimatedSpeakTime","Math","max","currentQuestion","questionText","type","options","map","option","idx","join","startListening","isSupportedByBrowser","init","onResult","transcript","isFinal","onEnd","finalTranscript","handleVoiceResponse","onError","errorMessage","started","start","message","response","trim","updatedResponses","speakConfirmationSummary","summaryText","forEach","question","index","listenForConfirmation","result","analyzeIntent","toLowerCase","isAffirmative","intent","includes","isNegative","handleSubmit","lowerResponse","beep","Audio","volume","play","responseData","_id","questionId","responseText","questionType","submitResponse","farewell","state","fileName","_jsxFileName","lineNumber","columnNumber","className","children","title","description","onClick","disabled","_c","$RefreshReg$"],"sources":["C:/Users/josep/Documents/Sistema de Encuestas por Voz/client/src/pages/TakeSurvey.jsx"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\nimport { useParams, useNavigate } from 'react-router-dom';\nimport { SurveyService, ResponseService } from '../services/apiService';\n\n// Componentes\nimport LoadingSpinner from '../components/LoadingSpinner';\nimport ErrorMessage from '../components/ErrorMessage';\nimport audioService from '../services/audioService';\n// Importar servicio de procesamiento de lenguaje natural\nimport * as nlpService from '../services/nlpService';\n\nconst TakeSurvey = () => {\n  const { surveyId } = useParams();\n  const navigate = useNavigate();\n  \n  // Referencias para controlar el flujo de la conversación\n  const conversationActive = useRef(false);\n  const speakTimeoutRef = useRef(null);\n  \n  // Estados\n  const [survey, setSurvey] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState(null);\n  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);\n  const [responses, setResponses] = useState([]);\n  const [isSubmitting, setIsSubmitting] = useState(false);\n  const [showConfirmation, setShowConfirmation] = useState(false);\n  const [currentResponse, setCurrentResponse] = useState('');\n  const [isListening, setIsListening] = useState(false);\n  const [voiceEnabled, setVoiceEnabled] = useState(true);\n  const [conversationState, setConversationState] = useState('idle'); // idle, speaking, listening, processing\n  const [conversationMessage, setConversationMessage] = useState('');\n  const [micPermission, setMicPermission] = useState('unknown'); // 'unknown', 'granted', 'denied'\n  const [recognizedText, setRecognizedText] = useState('');\n  const [status, setStatus] = useState('');\n  const [showPermissionDialog, setShowPermissionDialog] = useState(false);\n  \n  // Verificar permiso del micrófono\n  const requestMicrophonePermission = async () => {\n    setConversationState('requesting_permission');\n    setConversationMessage('Solicitando permiso para el micrófono...');\n    \n    try {\n      const permissionGranted = await audioService.requestMicrophonePermission();\n      \n      if (permissionGranted) {\n        setMicPermission('granted');\n        setShowPermissionDialog(false);\n        setConversationMessage('Permiso concedido. Iniciando encuesta por voz...');\n        \n        // Pequeño retraso para iniciar la conversación\n        setTimeout(() => {\n          startConversation();\n        }, 1000);\n      } else {\n        setMicPermission('denied');\n        setConversationState('permission_denied');\n        setConversationMessage('Se necesita acceso al micrófono para usar la función de voz');\n      }\n    } catch (error) {\n      console.error('Error al solicitar permiso:', error);\n      setMicPermission('denied');\n      setConversationState('error');\n      setConversationMessage('Error al solicitar permiso del micrófono');\n    }\n  };\n  \n  // Cargar la encuesta\n  useEffect(() => {\n    const fetchSurvey = async () => {\n      try {\n        const data = await SurveyService.getPublicSurvey(surveyId);\n        console.log('Encuesta cargada:', data);\n        setSurvey(data);\n        // Inicializar respuestas vacías\n        setResponses(new Array(data.questions.length).fill(''));\n      } catch (error) {\n        console.error('Error al cargar la encuesta:', error);\n        setError('No se pudo cargar la encuesta. Verifique que el ID sea correcto y que la encuesta esté activa.');\n      } finally {\n        setLoading(false);\n      }\n    };\n    \n    fetchSurvey();\n    \n    // Inicializar sistema de voz\n    audioService.initSpeechSystem();\n    \n    // Configurar el callback para cambios en el permiso del micrófono\n    audioService.onPermissionChange((granted, errorMsg) => {\n      setMicPermission(granted ? 'granted' : 'denied');\n      if (!granted && errorMsg) {\n        setConversationMessage(`Error de permiso: ${errorMsg}`);\n        setConversationState('permission_denied');\n      }\n    });\n    \n    return () => {\n      // Detener cualquier síntesis y reconocimiento al desmontar\n      if (speakTimeoutRef.current) {\n        clearTimeout(speakTimeoutRef.current);\n      }\n      audioService.stop();\n      conversationActive.current = false;\n      \n      if (window.speechSynthesis) {\n        window.speechSynthesis.cancel();\n      }\n    };\n  }, [surveyId]);\n  \n  // Iniciar la conversación una vez que la encuesta esté cargada\n  useEffect(() => {\n    if (survey && voiceEnabled && !conversationActive.current) {\n      // Primero verificar permiso de micrófono\n      if (micPermission === 'granted') {\n        startConversation();\n      } else if (micPermission === 'unknown') {\n        // Mostrar diálogo de permiso\n        setShowPermissionDialog(true);\n      }\n    }\n  }, [survey, voiceEnabled, micPermission]);\n  \n  // Función para iniciar la conversación\n  const startConversation = () => {\n    if (!voiceEnabled || !survey) return;\n    \n    conversationActive.current = true;\n    \n    // Dar un mensaje de bienvenida\n    if (survey.welcomeMessage) {\n      speakText(survey.welcomeMessage, () => {\n        // Después de la bienvenida, preguntar la primera pregunta\n        speakCurrentQuestion();\n      });\n    } else {\n      // Si no hay mensaje de bienvenida, ir directamente a la primera pregunta\n      speakCurrentQuestion();\n    }\n  };\n  \n  // Función para hablar el texto usando el servicio de audio con pausas naturales\n  const speakText = (text, onEndCallback) => {\n    if (!voiceEnabled) {\n      if (onEndCallback) onEndCallback();\n      return;\n    }\n    \n    console.log('Preparando para hablar:', text);\n    \n    // Cancela cualquier síntesis en curso y limpia los timeouts anteriores\n    if (window.speechSynthesis) {\n      window.speechSynthesis.cancel();\n    }\n    \n    if (speakTimeoutRef.current) {\n      clearTimeout(speakTimeoutRef.current);\n      speakTimeoutRef.current = null;\n    }\n    \n    // Detener cualquier reconocimiento en curso para evitar conflictos\n    audioService.stop();\n    \n    // Pausa significativa antes de comenzar a hablar (1 segundo)\n    speakTimeoutRef.current = setTimeout(() => {\n      setConversationState('speaking');\n      setConversationMessage('Hablando: ' + text.substring(0, 30) + (text.length > 30 ? '...' : ''));\n      \n      // Calcular un tiempo estimado basado en la longitud del texto (125ms por carácter para ser más conservador)\n      const estimatedSpeakTime = Math.max(4000, text.length * 125);\n      console.log(`Tiempo estimado para hablar: ${estimatedSpeakTime}ms`);\n      \n      audioService.speakText(\n        text,\n        () => {\n          console.log('Comenzando a hablar:', text);\n        },\n        () => {\n          console.log('Terminó de hablar la frase completa');\n          setConversationState('processing');\n          setConversationMessage('Procesando...');\n          \n          // Esperar un tiempo más largo después de hablar (2 segundos) para una pausa natural\n          // Esta pausa simula el tiempo que una persona tomaría para procesar lo que escuchó\n          speakTimeoutRef.current = setTimeout(() => {\n            setConversationState('idle');\n            if (onEndCallback) {\n              onEndCallback();\n            }\n          }, 2000);\n        },\n        (error) => {\n          console.error('Error al hablar:', error);\n          setConversationState('error');\n          setConversationMessage(`Error: ${error}`);\n          \n          // En caso de error, esperar un poco antes de continuar\n          speakTimeoutRef.current = setTimeout(() => {\n            setConversationState('idle');\n            if (onEndCallback) {\n              onEndCallback();\n            }\n          }, 1500);\n        }\n      );\n    }, 1000); // Esperar 1 segundo antes de iniciar una nueva síntesis para asegurar separación clara\n  };\n  \n  // Función para hablar la pregunta actual\n  const speakCurrentQuestion = () => {\n    if (!survey || !voiceEnabled) return;\n    \n    const currentQuestion = survey.questions[currentQuestionIndex];\n    if (!currentQuestion) return;\n    \n    let questionText = `Pregunta ${currentQuestionIndex + 1}: ${currentQuestion.text}`;\n    \n    // Agregar información sobre opciones si es pregunta de opción múltiple\n    if (currentQuestion.type === 'multiple_choice' && currentQuestion.options) {\n      questionText += '. Las opciones son: ';\n      questionText += currentQuestion.options.map((option, idx) => \n        `Opción ${idx + 1}: ${option}`\n      ).join(', ');\n    }\n    \n    speakText(questionText, () => {\n      // Después de hablar la pregunta, iniciar el reconocimiento de voz\n      startListening();\n    });\n  };\n  \n  // Función para iniciar la escucha de la respuesta del usuario\n  const startListening = async () => {\n    if (!voiceEnabled) return;\n    \n    if (!audioService.isSupportedByBrowser()) {\n      setError('Tu navegador no soporta reconocimiento de voz');\n      return;\n    }\n    \n    if (micPermission !== 'granted') {\n      await requestMicrophonePermission();\n      return;\n    }\n    \n    audioService.init('es-ES');\n    \n    setRecognizedText('');\n    \n    audioService.onResult((transcript, isFinal) => {\n      setCurrentResponse(transcript);\n      setStatus(isFinal ? 'Procesando...' : 'Escuchando...');\n    });\n    \n    audioService.onEnd((finalTranscript) => {\n      setIsListening(false);\n      setConversationState('processing');\n      setConversationMessage('Procesando respuesta...');\n      \n      // Guardar la respuesta y continuar la conversación\n      handleVoiceResponse(finalTranscript);\n    });\n    \n    audioService.onError((errorMessage) => {\n      console.error('Error de reconocimiento:', errorMessage);\n      setError(`Error de reconocimiento: ${errorMessage}`);\n      setIsListening(false);\n      setConversationState('idle');\n      \n      // Reintentar la escucha después de un error\n      speakTimeoutRef.current = setTimeout(() => {\n        speakText('No pude entender tu respuesta. Por favor, inténtalo de nuevo.', () => {\n          startListening();\n        });\n      }, 1000);\n    });\n    \n    try {\n      const started = await audioService.start();\n      if (started) {\n        setIsListening(true);\n        setConversationState('listening');\n        setConversationMessage('Escuchando...');\n      } else {\n        setError('No se pudo iniciar el reconocimiento de voz');\n        setConversationState('idle');\n      }\n    } catch (error) {\n      setError(`Error al iniciar reconocimiento: ${error.message || 'Error desconocido'}`);\n      setConversationState('idle');\n    }\n  };\n  \n  // Manejar la respuesta por voz\n  const handleVoiceResponse = (response) => {\n    if (!response || response.trim() === '') {\n      // Si no hay respuesta, pedir que repita\n      speakText('No he escuchado ninguna respuesta. Por favor, intenta de nuevo.', () => {\n        startListening();\n      });\n      return;\n    }\n    \n    // Guardar la respuesta actual\n    const updatedResponses = [...responses];\n    updatedResponses[currentQuestionIndex] = response;\n    setResponses(updatedResponses);\n    \n    // Dar feedback al usuario\n    speakText(`He registrado tu respuesta: ${response}.`, () => {\n      // Pasar a la siguiente pregunta o finalizar\n      if (currentQuestionIndex < survey.questions.length - 1) {\n        setCurrentQuestionIndex(currentQuestionIndex + 1);\n        setCurrentResponse('');\n        // Hablar la siguiente pregunta después de un breve pausa\n        speakTimeoutRef.current = setTimeout(() => {\n          speakCurrentQuestion();\n        }, 1000);\n      } else {\n        // Si es la última pregunta, mostrar confirmación\n        setShowConfirmation(true);\n        speakText('Hemos terminado todas las preguntas. Ahora te mostraré un resumen de tus respuestas para que las confirmes.', () => {\n          speakConfirmationSummary();\n        });\n      }\n    });\n  };\n  \n  // Leer el resumen de confirmación\n  const speakConfirmationSummary = () => {\n    if (!voiceEnabled || !showConfirmation) return;\n    \n    let summaryText = 'Resumen de tus respuestas: ';\n    \n    survey.questions.forEach((question, index) => {\n      summaryText += `Pregunta ${index + 1}: ${question.text}. Tu respuesta: ${responses[index] || \"Sin respuesta\"}. `;\n    });\n    \n    summaryText += '¿Deseas enviar estas respuestas o volver para revisar alguna?';\n    \n    speakText(summaryText, () => {\n      // Escuchar confirmación del usuario\n      listenForConfirmation();\n    });\n  };\n  \n  // Escuchar la confirmación del usuario usando NLP para mejor reconocimiento\n  const listenForConfirmation = () => {\n    if (!voiceEnabled) return;\n    \n    // Esperar un momento antes de empezar a escuchar para dar tiempo a que termine de hablar\n    // y para simular un ritmo de conversación natural\n    setConversationState('waiting');\n    setConversationMessage('Esperando tu respuesta...');\n    \n    // Esperar 3 segundos antes de empezar a escuchar para una interacción más natural\n    setTimeout(() => {\n      audioService.init('es-ES');\n      \n      audioService.onResult((transcript, isFinal) => {\n        // Mostrar lo que está diciendo el usuario en tiempo real\n        setCurrentResponse(transcript);\n        setConversationMessage(isFinal ? 'Procesando tu respuesta...' : `Escuchando: ${transcript}`);\n      });\n      \n      audioService.onEnd((finalTranscript) => {\n        setIsListening(false);\n        setConversationState('processing');\n        setConversationMessage('Analizando respuesta...');\n        \n        console.log('Respuesta final recibida:', finalTranscript);\n        \n        // Usar una pausa para procesar la respuesta y dar una sensación más natural\n        setTimeout(() => {\n          // Analizar respuesta utilizando NLP para una mejor comprensión\n          try {\n            // Utilizar el servicio NLP para analizar respuesta de forma más precisa\n            const result = nlpService.analyzeIntent(finalTranscript.toLowerCase());\n            console.log('Análisis NLP:', result);\n            \n            // Comprobar si la intención es afirmativa\n            const isAffirmative = result.intent === 'afirmacion' || \n                              finalTranscript.toLowerCase().includes('sí') || \n                              finalTranscript.toLowerCase().includes('si') ||\n                              finalTranscript.toLowerCase().includes('confirmar') ||\n                              finalTranscript.toLowerCase().includes('enviar');\n                              \n            // Comprobar si la intención es negativa\n            const isNegative = result.intent === 'negacion' || \n                            finalTranscript.toLowerCase().includes('no') ||\n                            finalTranscript.toLowerCase().includes('revisar') ||\n                            finalTranscript.toLowerCase().includes('volver');\n            \n            if (isAffirmative) {\n              // Confirmado - enviar respuestas\n              setConversationState('confirmed');\n              setConversationMessage('Confirmado. Enviando respuestas...');\n              \n              speakText('Perfecto, estoy enviando tus respuestas ahora.', () => {\n                handleSubmit();\n              });\n            } else if (isNegative) {\n              // Volver a revisar\n              setConversationState('reviewing');\n              setConversationMessage('Volviendo a revisar las preguntas...');\n              \n              setShowConfirmation(false);\n              speakText('De acuerdo, volvamos a revisar las preguntas. Puedes navegar entre ellas usando los botones de anterior y siguiente.', null);\n            } else {\n              // Respuesta no clara - pedir clarificación\n              setConversationState('unclear');\n              setConversationMessage('No entendí tu respuesta...');\n              \n              speakText('No he entendido si deseas confirmar o revisar. Por favor, dime claramente \"confirmar\" para enviar las respuestas o \"revisar\" para volver a las preguntas.', () => {\n                // Intentar nuevamente después de una pausa \n                setTimeout(() => {\n                  listenForConfirmation();\n                }, 2000); // Esperar 2 segundos antes de volver a escuchar\n              });\n            }\n          } catch (error) {\n            console.error('Error al procesar la respuesta con NLP:', error);\n            // Fallback al método simple en caso de error con NLP\n            const lowerResponse = finalTranscript.toLowerCase();\n            \n            if (lowerResponse.includes('sí') || lowerResponse.includes('si') || \n                lowerResponse.includes('confirmar') || lowerResponse.includes('enviar')) {\n              speakText('Perfecto, enviando tus respuestas.', () => {\n                handleSubmit();\n              });\n            } else if (lowerResponse.includes('no') || lowerResponse.includes('revisar')) {\n              setShowConfirmation(false);\n              speakText('De acuerdo, volvamos a revisar las preguntas.', null);\n            } else {\n              speakText('No he entendido tu respuesta. Por favor, intenta de nuevo.', () => {\n                setTimeout(() => {\n                  listenForConfirmation();\n                }, 2000);\n              });\n            }\n          }\n        }, 1500); // Pausa para procesar la respuesta\n      });\n      \n      audioService.onError((errorMessage) => {\n        console.error('Error en reconocimiento de voz:', errorMessage);\n        setIsListening(false);\n        setConversationState('error');\n        setConversationMessage(`Error al escuchar: ${errorMessage}`);\n        \n        speakText('Hubo un problema al escuchar tu confirmación. Por favor, usa los botones en pantalla para confirmar o volver, o intenta hablar más claramente.', null);\n      });\n      \n      // Iniciar el reconocimiento de voz\n      audioService.start();\n      setIsListening(true);\n      setConversationState('listening');\n      setConversationMessage('Escuchando tu confirmación...');\n      \n      // Reproducir un sonido suave para indicar que está listo para escuchar\n      try {\n        const beep = new Audio('/assets/sounds/listen-beep.mp3');\n        beep.volume = 0.3;\n        beep.play();\n      } catch (error) {\n        console.log('No se pudo reproducir el sonido de inicio de escucha');\n      }\n    }, 3000); // Pausa considerable antes de empezar a escuchar\n  };\n  \n  // Enviar todas las respuestas\n  const handleSubmit = async () => {\n    setIsSubmitting(true);\n    \n    try {\n      // Preparar objeto de respuesta\n      const responseData = {\n        surveyId: survey._id,\n        responses: survey.questions.map((question, index) => ({\n          questionId: question._id,\n          questionText: question.text,\n          responseText: responses[index] || '',\n          questionType: question.type\n        }))\n      };\n      \n      // Enviar respuesta a la API\n      await ResponseService.submitResponse(responseData);\n      \n      // Mensaje de despedida\n      if (voiceEnabled) {\n        speakText(survey.farewell || '¡Gracias por completar la encuesta!', () => {\n          // Redirigir a página de agradecimiento\n          navigate(`/thank-you`, { \n            state: { \n              message: survey.farewell || '¡Gracias por completar la encuesta!' \n            } \n          });\n        });\n      } else {\n        // Redirigir a página de agradecimiento sin hablar\n        navigate(`/thank-you`, { \n          state: { \n            message: survey.farewell || '¡Gracias por completar la encuesta!' \n          } \n        });\n      }\n    } catch (error) {\n      console.error('Error al enviar respuestas:', error);\n      setError('Ocurrió un error al enviar tus respuestas. Por favor, intenta nuevamente.');\n      setIsSubmitting(false);\n      \n      if (voiceEnabled) {\n        speakText('Ha ocurrido un error al enviar tus respuestas. Por favor, intenta nuevamente.', null);\n      }\n    }\n  };\n  \n  // Renderizar pantalla de carga\n  if (loading) {\n    return <LoadingSpinner />;\n  }\n  \n  // Renderizar mensaje de error\n  if (error) {\n    return <ErrorMessage message={error} />;\n  }\n  \n  // Si no hay encuesta\n  if (!survey) {\n    return <ErrorMessage message=\"No se encontró la encuesta solicitada.\" />;\n  }\n  \n  // Obtener la pregunta actual\n  const currentQuestion = survey.questions[currentQuestionIndex];\n  \n  return (\n    <div className=\"max-w-3xl mx-auto p-4\">\n      {/* Estado de la conversación - Simplificado */}\n      <div className=\"mb-4 p-3 rounded-lg shadow-sm text-center bg-gray-100\">\n        <h2 className=\"text-lg font-bold mb-2\">{survey.title}</h2>\n        <p className=\"text-sm mb-3\">{survey.description}</p>\n        \n        {micPermission === 'unknown' && (\n          <button\n            onClick={requestMicrophonePermission}\n            className=\"px-4 py-2 bg-blue-600 text-white rounded-md mb-2\"\n          >\n            Permitir micrófono para continuar\n          </button>\n        )}\n        \n        {micPermission === 'denied' && (\n          <p className=\"text-red-600 mb-2\">Se necesita acceso al micrófono para usar la función de voz.</p>\n        )}\n        \n        <p className=\"font-semibold\">\n          {showConfirmation \n            ? \"Confirmación de respuestas\" \n            : `Pregunta ${currentQuestionIndex + 1} de ${survey.questions.length}`}\n        </p>\n        \n        {conversationState !== 'idle' && (\n          <p className=\"mt-2 text-blue-700\">{conversationMessage}</p>\n        )}\n      </div>\n      \n      {/* Contenido principal (Pregunta o Confirmación) */}\n      {showConfirmation ? (\n        <div className=\"bg-white rounded-lg shadow p-4 mb-4\">\n          <h3 className=\"text-xl font-bold mb-3\">Resumen de respuestas</h3>\n          <div className=\"max-h-60 overflow-y-auto mb-3\">\n            {survey.questions.map((question, index) => (\n              <div key={question._id} className=\"mb-2 pb-2 border-b border-gray-200\">\n                <p className=\"font-medium\">Pregunta {index + 1}: {question.text}</p>\n                <p className=\"pl-4\">{responses[index] || \"(Sin respuesta)\"}</p>\n              </div>\n            ))}\n          </div>\n          {isListening ? (\n            <p className=\"text-center text-green-700 animate-pulse\">\n              Di \"confirmar\" para enviar o \"revisar\" para volver\n            </p>\n          ) : (\n            <div className=\"flex justify-end mt-2\">\n              <button\n                onClick={() => {\n                  setShowConfirmation(false);\n                  setConversationState('reviewing');\n                  setConversationMessage('Revisando preguntas...');\n                }}\n                className=\"px-3 py-1 bg-gray-200 text-gray-800 rounded mr-2\"\n                disabled={isSubmitting}\n              >\n                Revisar\n              </button>\n              <button\n                onClick={handleSubmit}\n                className=\"px-3 py-1 bg-green-600 text-white rounded\"\n                disabled={isSubmitting}\n              >\n                {isSubmitting ? 'Enviando...' : 'Confirmar'}\n              </button>\n            </div>\n          )}\n        </div>\n      ) : (\n        <div className=\"bg-white rounded-lg shadow p-4 mb-4\">\n          <h3 className=\"text-xl font-bold mb-3\">{currentQuestion.text}</h3>\n          \n          {/* Opciones para preguntas de opción múltiple */}\n          {currentQuestion.type === 'multiple_choice' && currentQuestion.options && (\n            <div className=\"mb-4\">\n              <p className=\"text-sm text-gray-600 mb-1\">Opciones:</p>\n              <ul className=\"list-disc pl-5\">\n                {currentQuestion.options.map((option, idx) => (\n                  <li key={idx} className=\"mb-1\">{option}</li>\n                ))}\n              </ul>\n            </div>\n          )}\n          \n          {/* Respuesta actual */}\n          {isListening ? (\n            <div className=\"mt-3 p-3 bg-green-50 border border-green-200 rounded-md text-center animate-pulse\">\n              <p><span className=\"font-medium\">Escuchando</span>: {currentResponse || \"...\"}</p>\n            </div>\n          ) : (\n            <div className=\"mt-3\">\n              <p className=\"text-sm font-medium text-gray-700\">Tu respuesta:</p>\n              <p className=\"p-2 bg-gray-50 rounded min-h-10\">{currentResponse || \"Esperando respuesta por voz...\"}</p>\n              <button \n                onClick={startListening}\n                className=\"mt-2 px-3 py-1 bg-blue-500 text-white rounded-md text-sm\"\n              >\n                Responder por voz\n              </button>\n            </div>\n          )}\n          \n          {/* Botones de navegación mínimos */}\n          <div className=\"flex justify-between mt-4\">\n            <button\n              onClick={() => {\n                if (currentQuestionIndex > 0) {\n                  setCurrentQuestionIndex(currentQuestionIndex - 1);\n                  setCurrentResponse(responses[currentQuestionIndex - 1]);\n                }\n              }}\n              disabled={currentQuestionIndex === 0}\n              className=\"px-3 py-1 text-sm rounded disabled:opacity-50\"\n            >\n              ← Anterior\n            </button>\n            <button\n              onClick={() => {\n                const updatedResponses = [...responses];\n                updatedResponses[currentQuestionIndex] = currentResponse;\n                setResponses(updatedResponses);\n                \n                if (currentQuestionIndex < survey.questions.length - 1) {\n                  setCurrentQuestionIndex(currentQuestionIndex + 1);\n                  setCurrentResponse('');\n                } else {\n                  setShowConfirmation(true);\n                }\n              }}\n              className=\"px-3 py-1 text-sm bg-blue-500 text-white rounded\"\n            >\n              {currentQuestionIndex < survey.questions.length - 1 ? 'Siguiente →' : 'Revisar respuestas'}\n            </button>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default TakeSurvey;"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}